<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>naturelAƒ∞ Chat</title>
  <style>
    /* Temel stiller */
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      background: white;
      border: 1px solid #ccc;
    }
    .message-bubble {
      max-width: 70%;
      margin: 5px 0;
      padding: 10px;
      border-radius: 10px;
      position: relative;
      word-wrap: break-word;
    }
    .user-message {
      background: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
    }
    .bot-message {
      background: #ececec;
      align-self: flex-start;
      margin-right: auto;
    }
    .time-stamp {
      font-size: 0.7rem;
      color: gray;
      margin-top: 5px;
      text-align: right;
    }
    .bot-time-stamp {
      text-align: left;
    }
    footer {
      background: #eee;
      text-align: center;
      padding: 10px 0;
      font-size: 0.9rem;
      color: #555;
    }
    /* Buton ve input */
    #input-area {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
    }
    #message-input {
      flex-grow: 1;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: none;
    }
    #send-button {
      margin-left: 10px;
      padding: 8px 16px;
      font-size: 1rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #send-button:disabled {
      background: #9CCC9C;
      cursor: not-allowed;
    }
    #loading-spinner {
      display: none;
      margin-left: 10px;
      align-self: center;
    }
    #loading-spinner.visible {
      display: inline-block;
    }
    /* Stil se√ßici */
    #style-selector {
      margin-left: 10px;
      padding: 5px;
    }
    /* Mikrofon simgesi ve dinleme */
    #mic-button {
      margin-left: 10px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
    }
    #mic-icon {
      display: inline;
    }
    #listening-indicator {
      display: none;
      color: red;
      font-weight: bold;
      margin-left: 5px;
    }
    #listening-indicator.visible {
      display: inline;
    }
    /* TTS toggle */
    #tts-toggle-label {
      margin-left: 15px;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>

  <div id="chat-container">
    <div class="message-bubble bot-message">
      <p>Merhaba! Nasƒ±l yardƒ±mcƒ± olabilirim?</p>
      <div class="time-stamp bot-time-stamp" id="first-message-time"></div>
    </div>
  </div>

  <div id="input-area">
    <textarea id="message-input" rows="1" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."></textarea>
    <button id="send-button" type="button">G√∂nder</button>
    <select id="style-selector" title="Konu≈üma Stili">
      <option value="professional" selected>Profesyonel & Resmi</option>
      <option value="friendly">Samimi & Arkada≈ü√ßa</option>
      <option value="funny">Esprili & Eƒülenceli</option>
      <option value="minimal">Minimalist & Direkt</option>
    </select>
    <button id="mic-button" title="Sesle Yaz"><span id="mic-icon">üé§</span></button>
    <span id="listening-indicator" aria-live="polite" role="status">Dinleniyor...</span>
    <label id="tts-toggle-label">
      <input type="checkbox" id="tts-toggle" checked /> Sesli Okuma
    </label>
    <div id="loading-spinner">‚è≥</div>
  </div>

  <footer class="bg-gray-100 py-3">
    &copy; 2025 naturelAƒ∞
  </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function formatTime(date) {
    return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
  }

  const firstMessageTimeElement = document.getElementById('first-message-time');
  if (firstMessageTimeElement) {
    firstMessageTimeElement.textContent = formatTime(new Date());
  }

  const chatContainer = document.getElementById('chat-container');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-button');
  const styleSelector = document.getElementById('style-selector');
  const loadingSpinner = document.getElementById('loading-spinner');
  const micButton = document.getElementById('mic-button');
  const micIcon = document.getElementById('mic-icon');
  const listeningIndicator = document.getElementById('listening-indicator');
  const ttsToggle = document.getElementById('tts-toggle');

  // Load chat history from localStorage or start fresh
  let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');

  function scrollToBottom() {
    setTimeout(() => {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 50);
  }

  function addMessage(message, isUser = false, time = new Date(), saveToHistory = true) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message-bubble');
    messageElement.classList.add(isUser ? 'user-message' : 'bot-message');

    const messageText = document.createElement('p');
    messageText.textContent = message;
    messageElement.appendChild(messageText);

    const timeStamp = document.createElement('div');
    timeStamp.classList.add('time-stamp');
    if (!isUser) timeStamp.classList.add('bot-time-stamp');

    const formattedTime = (typeof time === 'string') ? time : formatTime(time);
    timeStamp.textContent = formattedTime;
    messageElement.appendChild(timeStamp);

    chatContainer.appendChild(messageElement);
    scrollToBottom();

    if (saveToHistory) {
      chatHistory.push({ message, isUser, time: formattedTime });
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    if (!isUser) {
      speakText(message);
    }
  }

  function loadChatHistory() {
    // Clear except welcome message
    while (chatContainer.childElementCount > 1) {
      chatContainer.removeChild(chatContainer.lastChild);
    }

    chatHistory.forEach(item => {
      addMessage(item.message, item.isUser, item.time, false);
    });

    scrollToBottom();
  }

  async function sendMessage() {
    const message = messageInput.value.trim();
    if (message === '') return;

    // Disable UI during send
    messageInput.disabled = true;
    sendButton.disabled = true;
    loadingSpinner.classList.add('visible');

    addMessage(message, true);

    try {
      const styleMap = {
        professional: "Profesyonel & Resmi",
        friendly: "Samimi & Arkada≈ü√ßa",
        funny: "Esprili & Eƒülenceli",
        minimal: "Minimalist & Direkt"
      };

      const payload = {
        userMessage: message,
        style: styleMap[styleSelector.value] || styleMap.professional
      };

      let loopId;
      if (styleSelector.value === 'funny') {
        loopId = 'fac2e317-e352-42a8-930c-552123d6499e';
      } else if (styleSelector.value === 'friendly') {
        loopId = 'e0a0519e-409e-4ff8-bfba-4a5a5261217c';
      } else {
        loopId = '5057b32c-ea45-418d-8e45-37270c15289f';
      }

      const response = await fetch(`https://magicloops.dev/api/loop/${loopId}/run`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const { reply } = await response.json();

      addMessage(reply);
    } catch (error) {
      console.error('API √ßaƒürƒ±sƒ± hatasƒ±:', error);
      addMessage("√úzg√ºn√ºm, bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.");
    } finally {
      messageInput.disabled = false;
      sendButton.disabled = false;
      loadingSpinner.classList.remove('visible');
      messageInput.value = '';
      messageInput.focus();
    }
  }

  // Speech Recognition
  let recognition = null;
  if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'tr-TR';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      messageInput.value = transcript;
    };

    recognition.onend = function() {
      stopListening();
    };

    recognition.onerror = function(event) {
      console.error('Speech recognition error:', event.error);
      stopListening();
    };
  } else {
    micButton.style.display = 'none';
  }

  function startListening() {
    if (!recognition) {
      alert('Tarayƒ±cƒ±nƒ±z ses tanƒ±ma √∂zelliƒüini desteklemiyor.');
      return;
    }
    micIcon.style.display = 'none';
    listeningIndicator.classList.add('visible');
    recognition.start();
  }

  function stopListening() {
    if (!recognition) return;
    micIcon.style.display = 'inline';
    listeningIndicator.classList.remove('visible');
    recognition.stop();
  }

  // Text to Speech
  const speechSynthesis = window.speechSynthesis;

  function speakText(text) {
    if (!speechSynthesis) return;
    speechSynthesis.cancel();
    if (!ttsToggle.checked) return;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'tr-TR';

    const voices = speechSynthesis.getVoices();
    const turkishVoice = voices.find(v => v.lang.includes('tr-TR'));
    if (turkishVoice) utterance.voice = turkishVoice;

    speechSynthesis.speak(utterance);
  }

  speechSynthesis.onvoiceschanged = function() {
    speechSynthesis.getVoices();
  };

  // Event Listeners
  sendButton.addEventListener('click', e => {
    e.preventDefault();
    sendMessage();
  });

  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  micButton.addEventListener('click', () => {
    if (listeningIndicator.classList.contains('visible')) {
      stopListening();
    } else {
      startListening();
    }
  });

  // Load history and scroll
  loadChatHistory();

});
</script>
</body>
</html>


   
